# Backend Architecture & Conventions

This document provides a detailed guide to the structure, conventions, and patterns used in the `packages/api` service. It is intended for developers working on the backend to ensure consistency and maintainability.

## Technology Stack

The backend is a Node.js application built with the following core technologies:

*   **Framework:** [Express.js](https://expressjs.com/) for routing and middleware.
*   **Database:** [PostgreSQL](https://www.postgresql.org/)
*   **ORM:** [Prisma](https://www.prisma.io/) for database access and migrations.
*   **Authentication:** [Passport.js](http://www.passportjs.org/) for handling authentication strategies, primarily OIDC.
*   **Sessions:** [express-session](https://www.npmjs.com/package/express-session) with [PrismaSessionStore](https://www.npmjs.com/package/@quixo3/prisma-session-store) for persistent, database-backed sessions.
*   **DAST Scanning:** [OWASP ZAP](https://zaproxy.org/) Docker container integration for automated web application security testing.

## Directory Structure

The `packages/api` directory is organized as follows:

```
packages/api/
├── prisma/
│   ├── schema.prisma   # The single source of truth for the database schema.
│   ├── migrations/     # Database migration files generated by Prisma.
│   └── seed.js         # Seed script for populating development data.
└── src/
    ├── index.js        # Application entry point, middleware setup, and server start.
    ├── middleware/     # Custom Express middleware (e.g., auth checks).
    ├── routes/         # API route definitions, one file per resource.
    └── utils/          # Helper functions, business logic, and integrations:
        ├── crypto.js         # Encryption/decryption utilities
        ├── passport.js       # Authentication configuration
        ├── findings.js       # GitHub/Snyk findings synchronization
        ├── dastService.js    # DAST scanner factory and service
        ├── dastScannerBase.js # Abstract base class for DAST scanners
        ├── zapScanner.js     # OWASP ZAP scanner implementation
        └── scanProcessor.js  # Background scan processing and results
```

---

## Key Concepts & Conventions

### 1. Configuration

*   Environment variables are managed using the `dotenv` package.
*   The primary configuration file for local development is `.env` in the project root.
*   A `.env.example` file is provided as a template. **Never commit the `.env` file.**
*   Key variables include `DATABASE_URL`, `SESSION_SECRET`, and `ENCRYPTION_KEY`.

### 2. Routing

*   API endpoints are organized into separate files within `src/routes/` based on the resource they handle (e.g., `teams.js`, `projects.js`).
*   Each route file creates an `express.Router()`.
*   All routes are prefixed with `/api/v1` in the main `src/index.js` file.
*   **To add a new route:**
    1.  Create or open the appropriate resource file in `src/routes/`.
    2.  Define the new endpoint on the router (e.g., `router.get('/:id', ...)`)
    3.  Ensure the file is imported and used in `src/index.js`.

### 3. Database Interaction

*   **Prisma is the single source of truth.** All database schema changes **must** be done in `prisma/schema.prisma`.
*   After changing the schema, run `npx prisma migrate dev --name <migration-name>` to create a migration file and apply it to your database.
*   A single `PrismaClient` instance is created in `src/index.js` and should be used for all database queries. For simplicity in this project, we are not passing the client instance around but rather creating new instances where needed.
*   Example query: `const user = await prisma.user.findUnique({ where: { id } });`

### 4. Authentication & Authorization

*   **Authentication:** The API uses a stateful, session-based authentication model.
    *   Upon successful login, a session is created in the `Session` table in the database.
    *   A secure cookie containing the session ID is sent to the client.
    *   On subsequent requests, `passport.deserializeUser` uses the session ID to fetch the user's data, including their direct memberships and their team memberships.
*   **OIDC:** The primary authentication strategy is OpenID Connect (OIDC), implemented in `src/utils/passport.js`. The configuration is dynamic, allowing different organizations to configure their own IdPs.
*   **Authorization (Permissions):**
    *   Authorization logic is handled within the route handlers using the `checkPermission` utility from `src/utils/permissions.js`.
    *   The deserialized `req.user` object contains all the memberships needed to evaluate permissions.
    *   The `checkPermission` function takes the user, a required permission string (e.g., `'project:read'`), and the resource being accessed. It returns `true` or `false`.
    *   This function dynamically checks for permissions granted directly to the user, inherited from the user's teams, or inherited from parent resources in the hierarchy.
    *   Example: `const canView = await checkPermission(req.user, 'project:read', 'project', projectId);`

### 5. Security

*   **Sensitive Data:** Any sensitive information stored in the database that is not required for querying (e.g., external API keys, secrets) **must** be encrypted.
*   **Encryption Utility:** Use the `encrypt` and `decrypt` functions from `src/utils/crypto.js`.
*   **Encryption Key:** This system relies on the `ENCRYPTION_KEY` environment variable. This key must be a 64-character hex string and must be kept secret. Losing or changing this key will result in data loss.

### 6. DAST Scanning Architecture

The DAST (Dynamic Application Security Testing) scanning feature provides automated web application security testing using OWASP ZAP.

#### Components

*   **Scanner Abstraction Layer (`dastScannerBase.js`):** Abstract base class defining the interface for DAST scanners, enabling support for multiple scanning tools.
*   **ZAP Scanner Implementation (`zapScanner.js`):** Concrete implementation for OWASP ZAP integration with comprehensive error handling and retry logic.
*   **Service Factory (`dastService.js`):** Factory pattern for creating scanner instances based on provider type.
*   **Background Processing (`scanProcessor.js`):** Handles scan lifecycle management, results processing, and findings integration.

#### Database Models

*   **`ScanExecution`:** Tracks scan lifecycle with status, progress, configuration, and results.
*   **Enhanced `Finding` Model:** Includes URL field for DAST findings to track where vulnerabilities were discovered.
*   **Enums:** `DastScanType` and `ScanStatus` for type safety and validation.

#### Integration Points

*   **Docker Infrastructure:** ZAP runs in isolated container with persistent sessions and data volumes.
*   **Background Jobs:** Scans run asynchronously with real-time status polling.
*   **Findings Integration:** Results automatically create Vulnerability and Finding records.
*   **Permissions:** Integrates with the new permission-based access control (PBAC) model.

#### API Endpoints

*   **`/api/projects/:id/dast/*`:** RESTful endpoints for scan management (launch, status, results, cancel).
*   **Real-time Updates:** Polling-based progress monitoring with intelligent fallback.
*   **Detailed Reporting:** Comprehensive scan information including crawled pages and ZAP statistics.

For detailed DAST scanning documentation, see [DAST Scanning Feature](../dast-scanning-feature.md) and [DAST Scans API](../api/dast-scans.md). 