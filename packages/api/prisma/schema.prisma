datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  //url      = "postgresql://admin:password@localhost:5432/stagehand?schema=public"
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-1.1.x", "linux-musl-arm64-openssl-3.0.x"]
}

// Hierarchical Role Definition
enum Role {
  ADMIN
  EDITOR
  READER
}

enum VerificationStatus {
  PENDING
  VERIFIED
}

enum DeploymentStatus {
  PLANNING
  IN_DEVELOPMENT
  TESTING
  RELEASED
  MAINTENANCE
  DISCONTINUED
}

enum TechnologyType {
  LANGUAGE
  FRAMEWORK
  LIBRARY
  TOOL
  PLATFORM
  SERVICE
}

enum ProjectType {
  SERVICE
  LIBRARY
  FRONTEND_APP
  BACKEND_APP
  MOBILE_APP
  OWNED_HARDWARE
  CLOUD_HARDWARE
  EXTERNAL_BOUGHT_SOFTWARE
  CLI_TOOL
  OTHER
}

enum DataClassification {
  PUBLIC
  INTERNAL
  SENSITIVE
  RESTRICTED
}

enum ApplicationCriticality {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SCMProvider {
  GITHUB
  BITBUCKET
  AZURE_DEVOPS
}

enum SecurityToolType {
  SAST
  DAST
  SCA
  APISEC
}

enum DastScanType {
  ACTIVE
  PASSIVE
  BASELINE
  FULL
  CUSTOM
}

enum ScanStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  IMPORTED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String? // Hashed password, optional for invited users
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emailVerified              Boolean   @default(false)
  verificationToken          String?
  verificationTokenExpiresAt DateTime?

  memberships        Membership[]
  invitation         Invitation?
  passwordResetToken PasswordResetToken?
  loginTokens        LoginToken[]

  contacts                 Contact[]
  scmIntegrations          SCMIntegration[]
  securityToolIntegrations SecurityToolIntegration[]
  initiatedScans           ScanExecution[]
}

model Session {
  id                       String                    @id @default(cuid())
  sid                      String                    @unique
  data                     String
  expiresAt                DateTime
  autoJoinDomains          AutoJoinDomain[]
  oidcConfiguration        OIDCConfiguration?        @relation(fields: [oIDCConfigurationId], references: [id])
  integrations             SCMIntegration[]
  securityToolIntegrations SecurityToolIntegration[]
  oIDCConfigurationId      String?
}

model Organization {
  id                    String   @id @default(cuid())
  name                  String
  description           String?
  accountType           String   @default("STANDARD") // STANDARD or ENTERPRISE
  hierarchyDisplayNames Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  defaultCompanyId      String?

  companies                Company[]
  memberships              Membership[]
  autoJoinDomains          AutoJoinDomain[]
  oidcConfiguration        OIDCConfiguration?
  integrations             SCMIntegration[]
  securityToolIntegrations SecurityToolIntegration[]
}

model Company {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  teams                    Team[]
  memberships              Membership[]
  autoJoinDomains          AutoJoinDomain[]
  integrations             SCMIntegration[]
  securityToolIntegrations SecurityToolIntegration[]
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  projects                 Project[]
  memberships              Membership[]
  integrations             SCMIntegration[]
  securityToolIntegrations SecurityToolIntegration[]
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  memberships Membership[]

  // --- Stagehand Fields ---
  /// Primary URL for the deployed application
  applicationUrl   String?
  /// Current public version, e.g., 2.1.4
  version          String?
  deploymentStatus DeploymentStatus @default(IN_DEVELOPMENT)

  // --- DAST Scanning Fields ---
  dastScanEnabled  Boolean? @default(false)
  lastDastScanDate DateTime?
  dastScanSettings Json? // Store tool-agnostic scan configuration

  /// Link to the source code repository (e.g., GitHub)
  repositoryUrl   String?
  /// Link to the CI/CD pipeline (e.g., Jenkins, GitHub Actions)
  ciCdPipelineUrl String?

  /// Timestamp of the last successful scan by any integrated tool
  lastScanDate DateTime?

  projectType            ProjectType?
  dataClassification     DataClassification?
  applicationCriticality ApplicationCriticality?
  isExternallyExposed    Boolean?                @default(false)

  communicationChannel String? // e.g., Slack channel link
  documentationUrl     String? // Link to general project documentation (e.g., Confluence)
  apiReferenceUrl      String? // Link to API documentation (e.g., Swagger, OpenAPI)
  runbookUrl           String? // Link to operational runbooks for on-call
  threatModelUrl       String? // Link to threat model document
  lastSecurityReview   DateTime? // Date of last manual security review

  /// Points of contact for this application
  contacts     ProjectContact[]
  technologies ProjectTechnology[]
  dependencies ProjectDependency[]

  outboundDependencies           ProjectRelationship[]     @relation("outboundDependencies")
  inboundDependencies            ProjectRelationship[]     @relation("inboundDependencies")
  integrations                   SCMIntegration[]          @relation("DirectProjectIntegrations")
  directSecurityToolIntegrations SecurityToolIntegration[] @relation("DirectProjectSecurityToolIntegrations")

  scmIntegrationId String?
  scmIntegration   SCMIntegration? @relation("ProjectRepositoryLink", fields: [scmIntegrationId], references: [id], onDelete: SetNull)

  securityToolIntegrationId String?
  securityToolIntegration   SecurityToolIntegration? @relation("ProjectSecurityToolLink", fields: [securityToolIntegrationId], references: [id], onDelete: SetNull)

  // Flexible JSON object for tool-specific IDs
  toolSpecificIds Json? @default("{}")

  findings       Finding[]
  scanExecutions ScanExecution[]
}

model ProjectRelationship {
  id          String  @id @default(cuid())
  description String?
  // Type of relationship, e.g., 'API', 'DATABASE', 'MESSAGE_QUEUE', 'DIRECT_DEPENDENCY'
  type        String

  // The project that has the dependency (the source of the connection)
  sourceProjectId String
  sourceProject   Project @relation("outboundDependencies", fields: [sourceProjectId], references: [id], onDelete: Cascade)

  // The project that is the dependency (the target of the connection)
  targetProjectId String
  targetProject   Project @relation("inboundDependencies", fields: [targetProjectId], references: [id], onDelete: Cascade)

  // A relationship of a certain type between two projects must be unique
  @@unique([sourceProjectId, targetProjectId, type])
}

model Invitation {
  id        String   @id @default(cuid())
  email     String   @unique
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  updatedAt DateTime  @updatedAt
}

model Membership {
  id     String @id @default(cuid())
  role   Role
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, organizationId])
  @@unique([userId, companyId])
  @@unique([userId, teamId])
  @@unique([userId, projectId])
}

model Contact {
  id    String  @id @default(cuid())
  name  String
  email String  @unique
  /// e.g., Engineering Manager, External Consultant
  role  String?

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  applications ProjectContact[]
}

model ProjectContact {
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  /// e.g., 'Primary Owner', 'Technical Lead', 'Product Manager'
  contactType String

  @@id([projectId, contactId, contactType])
}

model Technology {
  id   String         @id @default(cuid())
  name String // e.g., "React", "Snyk", "Jira", "Python"
  type TechnologyType // To categorize the technology

  applications ProjectTechnology[]
  dependencies ProjectDependency[]

  @@unique([name, type])
}

model ProjectTechnology {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  technologyId String
  technology   Technology @relation(fields: [technologyId], references: [id])

  /// e.g., 18.2.0 for React
  version String?
  /// How was this discovered? e.g., 'user-entered' or 'Discovered by Snyk'
  source  String

  @@unique([projectId, technologyId, version])
}

model ProjectDependency {
  id      String @id @default(cuid())
  name    String // e.g., "express"
  version String // e.g., "4.17.1"
  type    String // e.g., "npm", "maven"

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  technologyId String?
  technology   Technology? @relation(fields: [technologyId], references: [id])

  @@unique([projectId, name, version])
  @@index([name]) // Index for fast lookups by dependency name
  @@index([name, version]) // Index for fast lookups by name and version
}

model AutoJoinDomain {
  id               String             @id @default(cuid())
  domain           String
  role             Role
  status           VerificationStatus @default(PENDING)
  verificationCode String             @unique

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  Session   Session? @relation(fields: [sessionId], references: [id])
  sessionId String?

  @@unique([domain, organizationId])
  @@unique([domain, companyId])
}

model OIDCConfiguration {
  id               String  @id @default(cuid())
  organizationId   String  @unique
  isEnabled        Boolean @default(false)
  issuer           String  @unique
  clientId         String
  clientSecret     String
  authorizationUrl String
  tokenUrl         String
  userInfoUrl      String
  defaultRole      Role    @default(READER)
  buttonText       String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Session   Session[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  selector  String   @unique
  token     String
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model LoginToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
}

model SCMIntegration {
  id          String      @id @default(cuid())
  provider    SCMProvider
  displayName String?

  installationId        String?
  encryptedAccessToken  String
  encryptedRefreshToken String?

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation("DirectProjectIntegrations", fields: [projectId], references: [id], onDelete: Cascade)

  projectLinks Project[] @relation("ProjectRepositoryLink")

  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  syncLogs  IntegrationSyncLog[]
  Session   Session?             @relation(fields: [sessionId], references: [id])
  sessionId String?
}

model SecurityToolIntegration {
  id        String           @id @default(cuid())
  provider  String // e.g., "Snyk", "Dependabot"
  type      SecurityToolType // e.g., "SAST", "SCA"
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Flexible, encrypted credentials
  encryptedCredentials Json

  // Relationships to hierarchical entities
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  companyId      String?
  company        Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  teamId         String?
  team           Team?         @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // A security tool integration can be directly linked to multiple projects
  directProjectLinks Project[] @relation("DirectProjectSecurityToolIntegrations")
  linkedProjects     Project[] @relation("ProjectSecurityToolLink")

  syncLogs       IntegrationSyncLog[]
  scanExecutions ScanExecution[]
  Session        Session?             @relation(fields: [sessionId], references: [id])
  sessionId      String?
}

model IntegrationSyncLog {
  id              String    @id @default(cuid())
  status          String // 'SUCCESS', 'FAILURE', 'IN_PROGRESS'
  startTime       DateTime
  endTime         DateTime?
  errorMessage    String?   @db.Text
  findingsAdded   Int       @default(0)
  findingsUpdated Int       @default(0)
  syncedProjectsJson Json?
  scmIntegrationId          String?
  scmIntegration            SCMIntegration?          @relation(fields: [scmIntegrationId], references: [id], onDelete: Cascade)
  securityToolIntegrationId String?
  securityToolIntegration   SecurityToolIntegration? @relation(fields: [securityToolIntegrationId], references: [id], onDelete: Cascade)

  scanExecutions ScanExecution[]

  @@index([scmIntegrationId])
  @@index([securityToolIntegrationId])
}

enum FindingStatus {
  NEW
  TRIAGED
  IN_PROGRESS
  RESOLVED
  IGNORED
}

model Vulnerability {
  id              String              @id @default(cuid())
  // Canonical ID from the source, e.g., 'CVE-2023-1234' or 'GHSA-...'
  vulnerabilityId String
  source          String // e.g., 'SNYK', 'GITHUB', 'TRACEABLE'
  type            String? // e.g., 'CVE', 'GHSA'
  title           String
  description     String    @db.Text
  severity        String // e.g., 'CRITICAL', 'HIGH', 'MEDIUM', 'LOW'
  cvssScore       Float?
  remediation     String? @db.Text
  references      Json? // List of URLs to advisories

  findings Finding[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vulnerabilityId, source])
}

model Finding {
  id     String        @id @default(cuid())
  status FindingStatus @default(NEW)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  source          String              // Descriptive source string like "SNYK", "TRACEABLE"
  type            SecurityToolType?   // DAST, SAST, SCA, APISEC

  vulnerabilityId String
  vulnerability   Vulnerability @relation(fields: [vulnerabilityId, source], references: [vulnerabilityId, source])

  // URL where the vulnerability was found (specific URL or fallback to scan target)
  url String?

  // Source-specific details, e.g., { "dependencyName": "lodash", "filePath": "package-lock.json" }
  metadata Json?

  firstSeenAt DateTime  @default(now())
  lastSeenAt  DateTime  @updatedAt
  resolvedAt  DateTime?

  @@unique([projectId, vulnerabilityId, source])
  @@index([projectId])
  @@index([url])
}

model ScanExecution {
  id        String      @id @default(cuid())
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Tool identification
  provider    String      // "OWASP_ZAP", "BURP_SUITE", etc.
  toolVersion String?     // Version of the scanning tool used

  // Scan configuration
  targetUrl String       // The URL that was scanned
  scanType  DastScanType @default(ACTIVE)
  status    ScanStatus

  // Timing (optional for imported scans)
  queuedAt    DateTime? // When scan was queued
  startedAt   DateTime? // When scan actually started
  completedAt DateTime? // When scan finished
  duration    Int?      // Scan duration in seconds

  // Error handling
  errorMessage String? @db.Text
  errorCode    String? // Tool-specific error codes

  // Results summary
  findingsCount Int @default(0)
  criticalCount Int @default(0)
  highCount     Int @default(0)
  mediumCount   Int @default(0)
  lowCount      Int @default(0)
  infoCount     Int @default(0)

  // Tool-specific configuration and metadata
  toolConfig   Json? // Scan parameters (policies, depth, etc.)
  toolMetadata Json? // Tool-specific data (scan ID, report URLs, etc.)

  // External scan tracking (for future use)
  externalScanId    String?  // ID from external tool
  externalReportUrl String?  // Link to external report
  isExternalScan    Boolean  @default(false) // Whether this was run externally

  // Integration tracking
  securityToolIntegrationId String?
  securityToolIntegration   SecurityToolIntegration? @relation(fields: [securityToolIntegrationId], references: [id])
  syncLogId                 String?
  syncLog                   IntegrationSyncLog?      @relation(fields: [syncLogId], references: [id])

  // User who initiated (optional for imported scans)
  initiatedById String?
  initiatedBy   User?   @relation(fields: [initiatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([provider])
  @@index([targetUrl])
}
